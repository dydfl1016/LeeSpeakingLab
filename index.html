<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeEnglish Speaking Lab (í†µí•©í˜•)</title>
  <style>
    :root{
      --bg:#f4f7f6; --card:#fff; --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --success:#16a34a; --danger:#dc2626; --dark:#111827;
      --border:#e5e7eb; --soft:#eff6ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      display:flex; justify-content:center; padding:18px;
    }
    .container{
      width:100%; max-width:560px; background:var(--card);
      border-radius:20px; box-shadow:0 10px 25px rgba(0,0,0,.08);
      padding:16px;
    }
    h1{font-size:18px; margin:0 0 10px}
    .sub{font-size:12px; color:var(--muted); line-height:1.45; margin-bottom:12px}
    .panel{
      border:1px solid var(--border); border-radius:16px; padding:12px; background:#fff;
      margin-bottom:12px;
    }
    .grid{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .grid3{
      display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;
    }
    select{
      width:100%; padding:12px; border-radius:14px; border:1px solid var(--border);
      font-size:14px; background:#fff; font-weight:800; outline:none;
    }
    .prompt{
      background:var(--soft); border:1px solid #dbeafe;
      padding:14px; border-radius:14px;
      min-height:82px; display:flex; align-items:center; justify-content:center;
      text-align:center; font-size:18px; font-weight:900; color:#1d4ed8;
    }
    .row{display:flex; gap:10px; margin-top:10px}
    button{
      width:100%; padding:13px 12px; border:none; border-radius:14px;
      font-size:15px; font-weight:900; cursor:pointer; transition:.15s;
    }
    button:active{transform:scale(.99)}
    .btn-dark{background:var(--dark); color:#fff}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-success{background:var(--success); color:#fff}
    .btn-danger{background:var(--danger); color:#fff}
    .btn-ghost{background:#fff; border:1px solid var(--border); color:var(--text); font-weight:800}
    .status{margin-top:8px; font-size:13px; color:var(--muted); min-height:18px}

    .hint{
      margin-top:10px; padding:10px; border-radius:12px;
      background:#fff; border:1px dashed #c7d2fe; display:none;
    }
    .hint-title{font-size:12px; color:#3730a3; font-weight:900; margin-bottom:6px}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff;
      font-weight:800;
    }
    .chip.bad{background:#fee2e2; color:#991b1b; border-color:#fecaca}
    .chip.good{background:#dcfce7; color:#166534; border-color:#bbf7d0}

    .box{
      margin-top:10px; border:1px solid var(--border);
      border-radius:14px; padding:12px; background:#fafafa;
    }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    textarea{
      width:100%; min-height:88px; resize:vertical;
      padding:10px; border:1px solid var(--border); border-radius:12px;
      font-size:14px; line-height:1.45; outline:none; background:#fff;
    }
    .mini{display:flex; gap:10px; margin-top:10px}
    audio{width:100%}

    .result{
      margin-top:12px; border-left:5px solid var(--primary);
      background:#f8fafc; padding:12px; border-radius:12px;
      display:none; font-size:14px; line-height:1.55;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:9999;
    }
    .modal{
      width:100%; max-width:440px; background:#fff; border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden;
    }
    .modal-h{
      padding:14px 14px 10px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal-h strong{font-size:14px}
    .modal-b{padding:14px; font-size:14px; line-height:1.5}
    .modal-f{padding:12px 14px; border-top:1px solid var(--border)}
    .modal-x{
      width:auto; padding:8px 10px; border-radius:10px;
      background:#f3f4f6; color:#111827; font-weight:900; border:1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LeEnglish Speaking Lab (í†µí•©í˜• MVP)</h1>
    <div class="sub">
      âœ… ì½”ìŠ¤/êµì¬/ìœ ë‹› ì„ íƒ â†’ â€œìƒˆ ë¬¸ì¥â€ â†’ ì˜ì–´ë¡œ ë§í•˜ê¸°(ë…¹ìŒ) â†’ ë‚´ ëª©ì†Œë¦¬ ë“£ê¸° â†’ (ê°€ëŠ¥í•˜ë©´) STT â†’ AI ê°„ë‹¨ í‰ê°€<br/>
      â€» STTëŠ” ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ë”°ë¼ í’ˆì§ˆ ì°¨ì´ê°€ í½ë‹ˆë‹¤. (ë…¹ìŒ/ì¬ìƒì€ HTTPSì—ì„œ ì˜ ë™ì‘)
    </div>

    <div class="panel">
      <div class="grid3">
        <div>
          <label>ì½”ìŠ¤</label>
          <select id="courseSelect"></select>
        </div>
        <div>
          <label>êµì¬</label>
          <select id="bookSelect"></select>
        </div>
        <div>
          <label>ìœ ë‹›</label>
          <select id="unitSelect"></select>
        </div>
      </div>

      <div class="row">
        <button class="btn-dark" id="btnNext">ìƒˆ ë¬¸ì¥</button>
        <button class="btn-ghost" id="btnHint">ì–¸ìŠ¤í¬ë¨ë¸” íŒíŠ¸: OFF</button>
        <button class="btn-ghost" id="btnShuffleHint">íŒíŠ¸ ì„ê¸°</button>
      </div>

      <div id="koreanPrompt" class="prompt">ìœ„ì—ì„œ ì½”ìŠ¤/êµì¬/ìœ ë‹›ì„ ì„ íƒí•˜ê³  â€œìƒˆ ë¬¸ì¥â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>

      <div id="hintBox" class="hint">
        <div class="hint-title">ğŸ” ë‹¨ì–´ ì¹´ë“œ(ìˆœì„œ ë°”ê¿”ì„œ) â€” ì´ ìˆœì„œëŒ€ë¡œ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë§í•´ë³´ì„¸ìš”!</div>
        <div class="chips" id="hintChips"></div>
      </div>

      <div class="status" id="status"></div>
    </div>

    <div class="panel">
      <div class="row">
        <button class="btn-success" id="btnRecord">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
        <button class="btn-primary" id="btnSTT">ğŸ“ STT ì‹œì‘</button>
      </div>

      <div class="box">
        <label>ğŸ§ ë‚´ ëª©ì†Œë¦¬ ë“£ê¸° (ë…¹ìŒ í›„ ìë™ ìƒì„±)</label>
        <audio id="playback" controls></audio>

        <div class="mini">
          <button class="btn-ghost" id="btnClear">ì´ˆê¸°í™”</button>
          <button class="btn-primary" id="btnAnalyze">AI ê°„ë‹¨ í‰ê°€</button>
        </div>

        <div style="margin-top:12px">
          <label>ğŸ“ STT ê²°ê³¼(ì˜ì–´) â€” ì¸ì‹ì´ í‹€ë¦¬ë©´ ì§ì ‘ ìˆ˜ì •í•´ë„ OK</label>
          <textarea id="sttText" placeholder="STT ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤... (ë˜ëŠ” ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)"></textarea>
        </div>

        <div id="result" class="result"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="modalTitle">ì•Œë¦¼</strong>
        <button class="modal-x" id="modalClose">ë‹«ê¸°</button>
      </div>
      <div class="modal-b" id="modalBody"></div>
      <div class="modal-f">
        <button class="btn-primary" id="modalOk">í™•ì¸</button>
      </div>
    </div>
  </div>

<script>
  /******************************************************************
   * âœ… DATAë§Œ ê³„ì† ëˆ„ì í•´ì„œ ë³µë¶™í•˜ë©´ ë¨
   *
   * êµ¬ì¡°:
   * DATA[ì½”ìŠ¤][êµì¬][Unit n] = [ { ko, en, scramble, keys }, ... ]
   *
   * ìœ ë‹›ì´ ëŠ˜ì–´ë‚˜ë©´?
   * - ê·¸ëƒ¥ "Unit 17" ê°™ì€ í‚¤ë¥¼ ì¶”ê°€í•˜ê³  ë°°ì—´ì— ë¬¸ì¥ ë„£ê¸°ë§Œ í•˜ë©´ ë.
   ******************************************************************/
  const DATA = {
    "ì´ˆë“± ë§í•˜ê¸°": {
      "íŒŒë‹‰ìŠ¤ ë¦¬ë”©": {
        "Unit 1": [
          { ko:"(ìƒ˜í”Œ) ë‚˜ëŠ” íŒ¬ì„ ì½ëŠ”ë‹¤.", en:"(Sample) I read Phonics.", scramble:["I","read","Phonics"], keys:["i","read","phonics"] }
        ]
      },
      "ë¦¬ë”©": {
        "Unit 13": [
          { ko:"ì‚¬ê³¼ í•œ ê°œê°€ ì±…ìƒ ìœ„ì— ìˆë‹¤.", en:"An apple is on the desk.", scramble:["on","An","apple","the","desk","is"], keys:["an","apple","is","on","the","desk"] },
          { ko:"ê°•ì•„ì§€ë“¤ì´ ì§‘ ì•ˆì— ìˆë‹¤.", en:"The dogs are in the house.", scramble:["The","dogs","in","are","the","house"], keys:["the","dogs","are","in","house"] },
          { ko:"ì˜¤ë Œì§€ë“¤ì´ íƒì ì•„ë˜ì— ìˆë‹¤.", en:"The oranges are under the table.", scramble:["under","are","the","table","The","oranges"], keys:["the","oranges","are","under","table"] },
          { ko:"ê³ ì–‘ì´ í•œ ë§ˆë¦¬ê°€ ë¬¸ ë’¤ì— ìˆë‹¤.", en:"A cat is behind the door.", scramble:["the","door","behind","A","cat","is"], keys:["a","cat","is","behind","the","door"] },
          { ko:"ë‚´ ì¹œêµ¬ë“¤ì´ ë²„ìŠ¤ ì˜†ì— ìˆë‹¤.", en:"My friends are next to the bus.", scramble:["My","friends","next","to","are","the","bus"], keys:["my","friends","are","next","to","the","bus"] }
        ],
        "Unit 14": [
          { ko:"(ìƒ˜í”Œ) ë² ìŠ¤ê°€ ë¬¼ê³ ê¸° íƒ±í¬ë¥¼ ë‘êº¼ìš´ ë§¤íŠ¸ ìœ„ì— ë‘”ë‹¤.", en:"Beth puts the fish tank on the thick mat.", scramble:["Beth","puts","the","fish","tank","on","the","thick","mat"], keys:["beth","puts","fish","tank","on","thick","mat"] }
        ]
      },
      "ë…¼í”½ì…˜ ë¦¬ë”©": {
        "Unit 1": [
          { ko:"(ìƒ˜í”Œ) ë‚˜ëŠ” ë™ë¬¼ì— ëŒ€í•´ ë°°ìš´ë‹¤.", en:"(Sample) I learn about animals.", scramble:["I","learn","about","animals"], keys:["i","learn","about","animals"] }
        ]
      }
    },

    "ì˜¤í”½": {
      "TV/ì‹œì²­": {
        "Unit 1": [
          { ko:"(ìƒ˜í”Œ) ë‚œ í‹°ë¹„ë¥¼ ìì£¼ ë³´ì§€ ì•ŠëŠ”ë‹¤. ë³¼ ë•ŒëŠ” ê·¸ëƒ¥ ì‰¬ë ¤ê³  ë³¸ë‹¤.", en:"(Sample) I don't watch TV often. I just watch it to relax.", scramble:["I","don't","watch","TV","often","I","just","watch","it","to","relax"], keys:["i","dont","watch","tv","often","just","to","relax"] }
        ]
      }
    }
  };

  // UI refs
  const courseSelect = document.getElementById("courseSelect");
  const bookSelect = document.getElementById("bookSelect");
  const unitSelect = document.getElementById("unitSelect");

  const elPrompt = document.getElementById("koreanPrompt");
  const elStatus = document.getElementById("status");
  const elStt = document.getElementById("sttText");
  const elResult = document.getElementById("result");

  const hintBox = document.getElementById("hintBox");
  const hintChips = document.getElementById("hintChips");

  const btnNext = document.getElementById("btnNext");
  const btnHint = document.getElementById("btnHint");
  const btnShuffleHint = document.getElementById("btnShuffleHint");
  const btnRecord = document.getElementById("btnRecord");
  const btnSTT = document.getElementById("btnSTT");
  const btnAnalyze = document.getElementById("btnAnalyze");
  const btnClear = document.getElementById("btnClear");
  const playback = document.getElementById("playback");

  // Modal
  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalOk = document.getElementById("modalOk");
  const modalClose = document.getElementById("modalClose");

  function showModal(title, body){
    modalTitle.textContent = title;
    modalBody.innerHTML = body;
    overlay.style.display = "flex";
  }
  function hideModal(){ overlay.style.display = "none"; }
  modalOk.addEventListener("click", hideModal);
  modalClose.addEventListener("click", hideModal);
  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) hideModal(); });

  function setStatus(msg){ elStatus.textContent = msg || ""; }

  // state
  let hintOn = false;
  let currentItem = null;
  let currentHint = [];

  function getCurrentList(){
    const c = courseSelect.value;
    const b = bookSelect.value;
    const u = unitSelect.value;
    const list = DATA?.[c]?.[b]?.[u];
    return Array.isArray(list) ? list : [];
  }

  function shuffle(arr){
    const a = (arr || []).slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function renderHint(){
    hintChips.innerHTML = "";
    currentHint.forEach(w=>{
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = w;
      hintChips.appendChild(span);
    });
  }

  function resetOutputs(){
    elStt.value = "";
    elResult.style.display = "none";
    elResult.innerHTML = "";
    playback.removeAttribute("src");
    playback.load();
  }

  function pickSentence(){
    const list = getCurrentList();
    if(list.length === 0){
      showModal("ë¬¸ì¥ì´ ì—†ì–´ìš”", "ì„ íƒí•œ ì½”ìŠ¤/êµì¬/ìœ ë‹›ì— ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤. DATAì— ë¬¸ì¥ì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”!");
      return;
    }
    currentItem = list[Math.floor(Math.random() * list.length)];

    elPrompt.textContent = currentItem.ko;
    resetOutputs();
    setStatus("ì˜ì–´ë¡œ ë§í•´ë³´ì„¸ìš”. (íŒíŠ¸ê°€ í•„ìš”í•˜ë©´ ON)");

    currentHint = shuffle(currentItem.scramble || []);
    if(hintOn){
      hintBox.style.display = "block";
      renderHint();
    } else {
      hintBox.style.display = "none";
    }
  }

  btnNext.addEventListener("click", pickSentence);

  btnHint.addEventListener("click", ()=>{
    hintOn = !hintOn;
    btnHint.textContent = hintOn ? "ì–¸ìŠ¤í¬ë¨ë¸” íŒíŠ¸: ON" : "ì–¸ìŠ¤í¬ë¨ë¸” íŒíŠ¸: OFF";
    if(!currentItem){
      setStatus("ë¬¸ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      hintBox.style.display = "none";
      return;
    }
    hintBox.style.display = hintOn ? "block" : "none";
    if(hintOn){
      if(!currentHint.length) currentHint = shuffle(currentItem.scramble || []);
      renderHint();
      setStatus("íŒíŠ¸ ON! ë‹¨ì–´ ì¹´ë“œë¥¼ ë³´ê³  ë¬¸ì¥ ìˆœì„œë¥¼ ë§Œë“¤ì–´ ë§í•´ë³´ì„¸ìš”.");
    } else {
      setStatus("íŒíŠ¸ OFF! ì´ì œ í•œê¸€ë§Œ ë³´ê³  ë§í•´ë³´ì„¸ìš”.");
    }
  });

  btnShuffleHint.addEventListener("click", ()=>{
    if(!currentItem){
      showModal("ë¬¸ì¥ ë¨¼ì €!", "ë¨¼ì € <b>ìƒˆ ë¬¸ì¥</b>ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    currentHint = shuffle(currentItem.scramble || []);
    if(hintOn){
      renderHint();
      setStatus("íŒíŠ¸ë¥¼ ë‹¤ì‹œ ì„ì—ˆì–´ìš”!");
    } else {
      setStatus("íŒíŠ¸ê°€ OFFì˜ˆìš”. ONìœ¼ë¡œ ì¼œë©´ ë‹¨ì–´ ì¹´ë“œê°€ ë³´ì…ë‹ˆë‹¤.");
    }
  });

  btnClear.addEventListener("click", ()=>{
    resetOutputs();
    setStatus("ì´ˆê¸°í™” ì™„ë£Œ");
  });

  // dropdown builders
  function setOptions(selectEl, items, placeholder){
    selectEl.innerHTML = "";
    (items || []).forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v; opt.textContent = v;
      selectEl.appendChild(opt);
    });
    if(items.length === 0){
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = placeholder || "(ì—†ìŒ)";
      selectEl.appendChild(opt);
    }
  }

  function buildCourse(){
    const courses = Object.keys(DATA);
    setOptions(courseSelect, courses, "ì½”ìŠ¤ ì—†ìŒ");
  }

  function buildBook(){
    const c = courseSelect.value;
    const books = c && DATA[c] ? Object.keys(DATA[c]) : [];
    setOptions(bookSelect, books, "êµì¬ ì—†ìŒ");
  }

  function buildUnit(){
    const c = courseSelect.value;
    const b = bookSelect.value;
    const units = (c && b && DATA[c] && DATA[c][b]) ? Object.keys(DATA[c][b]) : [];
    // ì´ˆë“±ì€ ëŒ€ì²´ë¡œ 1~16ì´ë‹ˆ, ì—†ëŠ” ìœ ë‹›ì„ "ì„ íƒì§€ë¡œë§Œ" ê¹”ì•„ë‘ëŠ” ì˜µì…˜ë„ ê°€ëŠ¥.
    // ì§€ê¸ˆì€ "ë°ì´í„°ê°€ ìˆëŠ” ìœ ë‹›ë§Œ" ë³´ì—¬ì£¼ëŠ” ë²„ì „.
    setOptions(unitSelect, units, "ìœ ë‹› ì—†ìŒ");
  }

  function onChangeSelection(){
    buildBook();
    buildUnit();
    currentItem = null;
    elPrompt.textContent = "â€œìƒˆ ë¬¸ì¥â€ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”";
    hintBox.style.display = "none";
    setStatus("ì„ íƒ ì™„ë£Œ. ìƒˆ ë¬¸ì¥ì„ ëˆŒëŸ¬ ë§í•˜ê¸° ì‹œì‘!");
    resetOutputs();
  }

  courseSelect.addEventListener("change", onChangeSelection);
  bookSelect.addEventListener("change", ()=>{
    buildUnit();
    currentItem = null;
    elPrompt.textContent = "â€œìƒˆ ë¬¸ì¥â€ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”";
    hintBox.style.display = "none";
    setStatus("ìœ ë‹›ê¹Œì§€ ì„ íƒ í›„ ìƒˆ ë¬¸ì¥ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
    resetOutputs();
  });
  unitSelect.addEventListener("change", ()=>{
    currentItem = null;
    elPrompt.textContent = "â€œìƒˆ ë¬¸ì¥â€ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”";
    hintBox.style.display = "none";
    setStatus("ìœ ë‹› ì„ íƒ ì™„ë£Œ! ìƒˆ ë¬¸ì¥ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    resetOutputs();
  });

  // init selects (ê¸°ë³¸ê°’: ì´ˆë“± ë§í•˜ê¸°)
  buildCourse();
  // ê¸°ë³¸ courseë¥¼ "ì´ˆë“± ë§í•˜ê¸°"ë¡œ ë§ì¶”ê³  ì‹¶ìœ¼ë©´:
  const defaultCourse = "ì´ˆë“± ë§í•˜ê¸°";
  if([...courseSelect.options].some(o=>o.value===defaultCourse)) courseSelect.value = defaultCourse;
  buildBook();

  const defaultBook = "ë¦¬ë”©";
  if([...bookSelect.options].some(o=>o.value===defaultBook)) bookSelect.value = defaultBook;
  buildUnit();

  const defaultUnit = "Unit 13";
  if([...unitSelect.options].some(o=>o.value===defaultUnit)) unitSelect.value = defaultUnit;

  setStatus("ì„ íƒ ì™„ë£Œ. ìƒˆ ë¬¸ì¥ì„ ëˆŒëŸ¬ ë§í•˜ê¸° ì‹œì‘!");

  // âœ… Recording (MediaRecorder)
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;

  async function toggleRecording(){
    if(!isRecording){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e)=>{ if(e.data.size>0) audioChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          stream.getTracks().forEach(t=>t.stop());
          const blob = new Blob(audioChunks, { type:"audio/webm" });
          const url = URL.createObjectURL(blob);
          playback.src = url;
          playback.load();
          setStatus("ë…¹ìŒ ì™„ë£Œ! â–¶ï¸ ë‚´ ëª©ì†Œë¦¬ ë“¤ì–´ë³´ê³ , STT/í‰ê°€ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
          showModal("ë…¹ìŒ ë!", "ì¢‹ì•„ìš”! ì´ì œ <b>ë‚´ ëª©ì†Œë¦¬</b>ë¥¼ ë“¤ì–´ë³´ê±°ë‚˜ <b>STT/AI í‰ê°€</b>ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.");
        };

        mediaRecorder.start();
        isRecording = true;
        btnRecord.textContent = "ğŸ›‘ ë…¹ìŒ ì¤‘ì§€";
        btnRecord.classList.remove("btn-success");
        btnRecord.classList.add("btn-danger");
        setStatus("ğŸ”´ ë…¹ìŒ ì¤‘... ì˜ì–´ë¡œ ì²œì²œíˆ ë˜ë°•ë˜ë°• ë§í•´ë³´ì„¸ìš”.");
      }catch(err){
        console.error(err);
        showModal("ë§ˆì´í¬ ê¶Œí•œ í•„ìš”", "ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì•¼ ë…¹ìŒí•  ìˆ˜ ìˆì–´ìš”. (ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©)");
      }
    } else {
      try{ mediaRecorder.stop(); }catch(e){}
      isRecording = false;
      btnRecord.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
      btnRecord.classList.remove("btn-danger");
      btnRecord.classList.add("btn-success");
    }
  }
  btnRecord.addEventListener("click", toggleRecording);

  // âœ… STT (SpeechRecognition)
  let recognition = null;
  let isSTT = false;

  function initSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = "en-US";
    r.continuous = true;
    r.interimResults = true;

    r.onresult = (event)=>{
      let transcript = "";
      for(let i=event.resultIndex;i<event.results.length;i++){
        transcript += event.results[i][0].transcript;
      }
      elStt.value = transcript.trim();
    };

    r.onerror = ()=>{
      isSTT = false;
      btnSTT.textContent = "ğŸ“ STT ì‹œì‘";
      btnSTT.classList.remove("btn-danger");
      btnSTT.classList.add("btn-primary");
      setStatus("STT ì˜¤ë¥˜/ì¤‘ë‹¨: ê¸°ê¸°/ë¸Œë¼ìš°ì €ì— ë”°ë¼ í’ˆì§ˆì´ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”.");
    };

    r.onend = ()=>{
      if(isSTT){
        isSTT = false;
        btnSTT.textContent = "ğŸ“ STT ì‹œì‘";
        btnSTT.classList.remove("btn-danger");
        btnSTT.classList.add("btn-primary");
        setStatus("STTê°€ ì¢…ë£Œëì–´ìš”. í•„ìš”í•˜ë©´ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.");
      }
    };

    return r;
  }

  btnSTT.addEventListener("click", ()=>{
    if(!recognition) recognition = initSTT();
    if(!recognition){
      showModal("STT ë¯¸ì§€ì›", "ì´ ë¸Œë¼ìš°ì €ëŠ” STT(Web Speech API)ë¥¼ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. ë…¹ìŒ/ì¬ìƒì€ ê³„ì† ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.");
      return;
    }
    if(!isSTT){
      try{
        recognition.start();
        isSTT = true;
        btnSTT.textContent = "ğŸ›‘ STT ì¤‘ì§€";
        btnSTT.classList.remove("btn-primary");
        btnSTT.classList.add("btn-danger");
        setStatus("ğŸŸ¦ STT ë“£ëŠ” ì¤‘... ì˜ì–´ë¡œ ë§í•´ë³´ì„¸ìš”.");
      }catch(e){
        setStatus("STTê°€ ì´ë¯¸ ì‹œì‘ëœ ìƒíƒœì¼ ìˆ˜ ìˆì–´ìš”.");
      }
    } else {
      try{ recognition.stop(); }catch(e){}
      isSTT = false;
      btnSTT.textContent = "ğŸ“ STT ì‹œì‘";
      btnSTT.classList.remove("btn-danger");
      btnSTT.classList.add("btn-primary");
      setStatus("STT ì¤‘ì§€ë¨");
    }
  });

  // âœ… Simple analysis (keyword coverage)
  function normalize(text){
    return (text||"")
      .toLowerCase()
      .replace(/[^a-z0-9\s']/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function analyze(){
    if(!currentItem){
      showModal("ë¬¸ì¥ ë¨¼ì €!", "ë¨¼ì € <b>ìƒˆ ë¬¸ì¥</b>ì„ ëˆŒëŸ¬ ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }
    const user = normalize(elStt.value);
    if(!user || user.length < 3){
      showModal("í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ì•„ìš”", "STTê°€ ë¹„ì—ˆê±°ë‚˜ ë„ˆë¬´ ì§§ì•„ìš”. <b>STT</b>ë¥¼ ì¼œê³  ë§í•´ë³´ê±°ë‚˜, ì§ì ‘ í•œ ì¤„ì´ë¼ë„ ì…ë ¥í•´ë³´ì„¸ìš”.");
      return;
    }

    const words = new Set(user.split(" "));
    const required = currentItem.keys || [];
    const missing = required.filter(k => !words.has(k));
    const hit = required.length - missing.length;
    const score = required.length ? Math.round((hit/required.length)*100) : 0;

    const tips = [];
    if(required.includes("is") && !words.has("is")) tips.push("beë™ì‚¬ <b>is</b>ê°€ í•„ìš”í•´ìš”.");
    if(required.includes("are") && !words.has("are")) tips.push("beë™ì‚¬ <b>are</b>ê°€ í•„ìš”í•´ìš”.");
    if(user.includes("next") && !user.includes("next to")) tips.push("<b>next to</b>ëŠ” ë‘ ë‹¨ì–´ë¥¼ ë¶™ì—¬ì„œ ë§í•´ìš”.");
    if(tips.length === 0) tips.push("ì¢‹ì•„ìš”! ì´ì œ íŒíŠ¸ë¥¼ ë„ê³ (OFF) í•œê¸€ë§Œ ë³´ê³  ë§í•´ë³´ì„¸ìš”.");

    const requiredHtml = `<div class="chips">${
      required.map(k => `<span class="chip ${words.has(k)?"good":"bad"}">${k}</span>`).join("")
    }</div>`;
    const missingHtml = missing.length
      ? `<div class="chips">${missing.map(m=>`<span class="chip bad">ëˆ„ë½: ${m}</span>`).join("")}</div>`
      : `<div class="chips"><span class="chip good">í‚¤ì›Œë“œ OK!</span></div>`;

    elResult.innerHTML = `
      <div><b>âœ… ëª¨ë²” ë¬¸ì¥(ì˜ˆì‹œ):</b><br/>${currentItem.en}</div>
      <div style="margin-top:10px"><b>ğŸ§  AI ê°„ë‹¨ ì ìˆ˜:</b> ${score}/100 (í‚¤ì›Œë“œ ê¸°ë°˜)</div>
      <div style="margin-top:8px"><b>ğŸ”‘ í‚¤ì›Œë“œ ì²´í¬</b></div>
      ${requiredHtml}
      ${missingHtml}
      <div style="margin-top:10px"><b>ğŸ“Œ í•œ ì¤„ í”¼ë“œë°±:</b><br/>${tips.map(t=>`â€¢ ${t}`).join("<br/>")}</div>
      <div style="margin-top:10px; color:#6b7280; font-size:12px">
        * MVP í‰ê°€ëŠ” STT í…ìŠ¤íŠ¸ ê¸°ë°˜ â€œí‚¤ì›Œë“œ ì»¤ë²„ë¦¬ì§€â€ë§Œ ì²´í¬í•©ë‹ˆë‹¤. (ì •êµí•œ ë¬¸ë²•/ë°œìŒ í‰ê°€ëŠ” API ì—°ê²° ì‹œ ê°€ëŠ¥)
      </div>
    `;
    elResult.style.display = "block";
    setStatus("í‰ê°€ ì™„ë£Œ! ë‹¤ì‹œ ë§í•´ë³´ê³  ì ìˆ˜ ì˜¬ë ¤ë³´ê¸° ğŸ‘Œ");
  }
  btnAnalyze.addEventListener("click", analyze);
</script>
</body>
</html>
